// ==UserScript==
// @name         布吉岛雨课堂导出工具 - 小窗试卷版
// @namespace    https://github.com/itkdm
// @version      0.1.0
// @description  布吉岛的小工具 - 导出雨课堂小窗试卷（iframe试卷），支持 MultipleChoice/FillBlank
// @match        https://www.yuketang.cn/v2/web/*
// @match        https://www.yuketang.cn/v/quiz/*
// @match        https://yuketang.cn/v2/web/*
// @match        https://yuketang.cn/v/quiz/*
// @grant        none
// ==/UserScript==

(function () {
  "use strict";

  /** =========================
   *  小工具
   *  ========================= */

  function nowString() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2, "0");
    return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
  }

  function safeJsonParse(s) {
    try { return JSON.parse(s); } catch { return null; }
  }

  function uniq(arr) {
    const seen = new Set();
    const out = [];
    for (const x of arr || []) {
      if (!x) continue;
      if (seen.has(x)) continue;
      seen.add(x);
      out.push(x);
    }
    return out;
  }

  // 去掉 html 标签，做个轻量文本提取（可选）
  function htmlToText(html) {
    if (!html) return "";
    return html
      .replace(/<br\s*\/?>/gi, "\n")
      .replace(/<\/p>/gi, "\n")
      .replace(/<[^>]+>/g, "")
      .replace(/&nbsp;/g, " ")
      .replace(/&lt;/g, "<")
      .replace(/&gt;/g, ">")
      .replace(/&amp;/g, "&")
      .trim();
  }

  // 支持标准 base64 / urlsafe base64
  function base64ToUtf8(b64) {
    if (!b64) return "";
    let s = b64.trim();

    // 可能出现 urlsafe
    s = s.replace(/-/g, "+").replace(/_/g, "/");

    // padding
    while (s.length % 4 !== 0) s += "=";

    // atob -> binary -> utf8
    const bin = atob(s);
    const bytes = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);

    // decode utf-8
    return new TextDecoder("utf-8").decode(bytes);
  }

  function downloadText(filename, text, mime = "text/plain;charset=utf-8") {
    const blob = new Blob([text], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  }

  /** =========================
   *  1) 从页面/URL推断 quizId
   *  ========================= */
  function detectQuizId() {
    const url = location.href;

    // 常见：/v2/web/studentQuiz/4229779/...
    let m = url.match(/studentQuiz\/(\d+)/i);
    if (m) return m[1];

    // 常见：/v\/quiz\/quiz_info\/4229779\/\?pageIndex=1
    m = url.match(/quiz_info\/(\d+)/i);
    if (m) return m[1];

    // 兜底：url 里出现 quiz_id=
    m = url.match(/[?&]quiz_id=(\d+)/i);
    if (m) return m[1];

    // 兜底：路径里单独出现数字（慎用）
    m = url.match(/\/(\d{6,})/);
    if (m) return m[1];

    return null;
  }

  /** =========================
   *  2) 拉取 quiz_info HTML 并解析出 quizData
   *  ========================= */
  async function fetchQuizInfoHtml(quizId) {
    // 你截图里 iframe src 就是 /v/quiz/quiz_info/<quizId>/?pageIndex=1
    const url = `https://www.yuketang.cn/v/quiz/quiz_info/${quizId}/?pageIndex=1`;
    const resp = await fetch(url, { credentials: "include" });
    if (!resp.ok) throw new Error(`fetch quiz_info failed: ${resp.status}`);
    return await resp.text();
  }

  function parseQuizInfoHtml(html) {
    // 提取 showAnswer / quizID / quizData(base64)
    const getVar = (name) => {
      const re = new RegExp(String.raw`var\s+${name}\s*=\s*['"]([^'"]+)['"]\s*;`, "i");
      const m = html.match(re);
      return m ? m[1] : null;
    };

    const quizID = getVar("quizID") || getVar("quizId") || null;
    const showAnswer = getVar("showAnswer"); // 'True'/'False'
    const quizAuth = getVar("quizAuth");

    // quizData 可能很长
    const m = html.match(/var\s+quizData\s*=\s*['"]([^'"]+)['"]\s*;/i);
    const quizDataB64 = m ? m[1] : null;

    if (!quizDataB64) {
      throw new Error("未在 quiz_info HTML 中找到 var quizData = '...';");
    }

    const jsonText = base64ToUtf8(quizDataB64);
    const quizJson = safeJsonParse(jsonText);
    if (!quizJson) {
      throw new Error("quizData base64 decode 后不是合法 JSON（可能编码方式变化）");
    }

    return {
      quizID,
      showAnswer,
      quizAuth,
      quizJson,
      raw: { quizDataB64 }
    };
  }

  /** =========================
   *  3) 从 quizJson 构建“导出结构”
   *  ========================= */

  function extractRemarkText(problem) {
    // Problem.RemarkRich.Shapes[].Paragraphs[].Lines[].Html
    const rr = problem?.RemarkRich;
    const shapes = rr?.Shapes || [];
    const texts = [];
    for (const s of shapes) {
      if (!s?.Paragraphs) continue;
      for (const p of s.Paragraphs) {
        const lines = p?.Lines || [];
        for (const ln of lines) {
          if (ln?.Html) texts.push(htmlToText(ln.Html));
        }
      }
    }
    return texts.join("\n").trim();
  }

  function collectUrlsFromSlide(slide) {
    const urls = [];

    // slide.Shapes[].URL
    for (const s of (slide?.Shapes || [])) {
      if (s?.URL) urls.push(s.URL);
    }

    // Problem.RemarkRich.Shapes[].URL
    const rrShapes = slide?.Problem?.RemarkRich?.Shapes || [];
    for (const s of rrShapes) {
      if (s?.URL) urls.push(s.URL);
    }

    return uniq(urls);
  }

  // 专门提取题干资源（只从 slide.Shapes 中获取，不包括 RemarkRich）
  function collectStemAssetsFromSlide(slide) {
    const urls = [];
    // 只从 slide.Shapes 中获取，不包括 RemarkRich
    for (const s of (slide?.Shapes || [])) {
      if (s?.URL) urls.push(s.URL);
    }
    return uniq(urls);
  }

  // 尝试把 MultipleChoice 的 A/B/C/D 匹配到对应 shape URL（基于 Top/Left 就近匹配，非100%）
  function mapChoicesByBullets(slide) {
    const bullets = slide?.Problem?.Bullets || [];
    const shapes = (slide?.Shapes || []).filter(s => s?.URL && typeof s.Top === "number" && typeof s.Left === "number");
    if (!bullets.length || !shapes.length) return { choices: {}, confidence: "low" };

    const used = new Set();
    const choices = {};

    for (const b of bullets) {
      const label = b?.Label;
      if (!label) continue;

      let best = null;
      let bestScore = Infinity;

      for (const s of shapes) {
        if (used.has(s.ID)) continue;
        // 通常选项在 bullet 右侧
        const leftOk = (typeof b.Left === "number") ? (s.Left >= b.Left) : true;
        if (!leftOk) continue;

        const dt = Math.abs((s.Top ?? 0) - (b.Top ?? 0));
        const dl = Math.abs((s.Left ?? 0) - (b.Left ?? 0));
        const score = dt * 2 + dl * 0.2; // 更看重纵向
        if (score < bestScore) {
          bestScore = score;
          best = s;
        }
      }

      if (best) {
        used.add(best.ID);
        choices[label] = best.URL;
      }
    }

    const conf = Object.keys(choices).length >= 2 ? "medium" : "low";
    return { choices, confidence: conf };
  }

  function buildExport(meta) {
    const quizJson = meta.quizJson;
    const slides = quizJson?.Slides || [];

    const problems = [];
    let qNo = 0;

    for (let i = 0; i < slides.length; i++) {
      const slide = slides[i];
      const p = slide?.Problem;
      if (!p || !p.Type) continue; // 没有 Problem 的 slide 跳过

      qNo += 1;
      const type = p.Type;
      const common = {
        no: qNo,
        slideIndex: i + 1,
        type,
        problemId: p.ProblemID ?? null,
        score: p.Score ?? p.DefaultScore ?? null,
        hasRemark: p.HasRemark ?? null,
        // 题面/选项资源URL（不OCR）
        assets: collectUrlsFromSlide(slide),
        rawProblem: p
      };

      if (type === "MultipleChoice") {
        const correct = p.Answer ?? null;
        const user = p.Result?.Answer ?? p.Result?.answer ?? null;
        const isCorrect = (correct != null && user != null) ? (String(correct) === String(user)) : null;

        const { choices, confidence } = mapChoicesByBullets(slide);
        
        // 解析内容（从RemarkRich提取）
        const explanationText = extractRemarkText(p) || null;
        
        // 题干资源：只从 slide.Shapes 中获取，排除选项资源后的第一个
        const stemAssets = collectStemAssetsFromSlide(slide);
        const choiceUrls = new Set(Object.values(choices || {}));
        const stemAsset = stemAssets.find(url => !choiceUrls.has(url)) || stemAssets[0] || null;

        problems.push({
          ...common,
          correctAnswer: correct,
          userAnswer: user,
          isCorrect,
          choiceAssets: choices,           // {A:url,B:url,...}（尽力匹配）
          choiceAssetsConfidence: confidence,
          stemAsset: stemAsset,            // 题干资源URL（第一个，排除选项后）
          explanationText: explanationText // 解析内容
        });
        continue;
      }

      if (type === "FillBlank") {
        const blanks = (p.Blanks || []).map(b => ({
          num: b.Num,
          answers: b.Answers || [],
          caseSensitive: b.CaseSensitive ?? false,
          fuzzyMatch: b.FuzzyMatch ?? false
        }));

        const userMap = p.Result?.Answer || {};          // { "1":"xxx", "2":"yyy" }
        const correctBlanks = p.Result?.CorrectBlanks || [];
        const finished = p.Result?.Finished ?? null;
        const correct = p.Result?.Correct ?? null;
        const score = p.Result?.Score ?? common.score ?? null;

        problems.push({
          ...common,
          blanks,
          orderInsensitive: p.OrderInsensitive ?? false,
          correctAnswerSummary: p.Answer ?? null,       // 例如 64K/2^16/...;32K/...
          userAnswerMap: userMap,
          correctBlanks,
          finished,
          isCorrect: correct,
          resultScore: score
        });
        continue;
      }

      // 其他题型：先占位（你说先不加，就先原样放着）
      problems.push(common);
    }

    return {
      meta: {
        exportedAt: new Date().toISOString(),
        quizId: meta.quizID || detectQuizId(),
        showAnswer: meta.showAnswer ?? null,
        title: quizJson?.Title ?? null,
        language: quizJson?.Language ?? null,
        version: quizJson?.Version ?? null,
        slideCount: slides.length,
        problemCount: problems.length
      },
      problems
    };
  }

  /** =========================
   *  4) 导出 Markdown
   *  ========================= */
  function toMarkdown(exportObj) {
    const m = exportObj.meta;
    const lines = [];

    lines.push(`# ${m.title || "试卷导出"}`);
    lines.push(`- quizId: \`${m.quizId || ""}\``);
    lines.push(`- exportedAt: \`${m.exportedAt}\``);
    lines.push(`- showAnswer: \`${m.showAnswer}\``);
    lines.push(`- slideCount: \`${m.slideCount}\``);
    lines.push(`- problemCount: \`${m.problemCount}\``);
    lines.push("");

    // 辅助函数：判断是否为图片URL（保留用于其他用途）
    function isImageUrl(url) {
      return /\.(jpg|jpeg|png|gif|bmp|webp|svg)(\?|$)/i.test(url) || /\/image\//i.test(url) || /\/slide_/i.test(url);
    }

    // 辅助函数：格式化图片URL（使用HTML格式确保MD解析器能正确显示）
    // 注意：雨课堂的图片URL可能没有文件扩展名，所以默认将所有URL都当作图片处理
    function formatImageUrl(url, alt, title, align = "left") {
      if (!url) return `- ${alt}: (无URL)`;
      // 默认将所有URL都当作图片处理（因为雨课堂的图片URL可能没有扩展名）
      // 使用HTML格式：Markdown原生支持HTML，兼容性最好
      // 添加样式确保图片左对齐（不居中）
      const alignStyle = align === "left" ? 'style="display: block; margin-left: 0; margin-right: auto; text-align: left;"' : '';
      return `<img src="${url}" alt="${alt}" title="${title}" ${alignStyle} />`;
    }

    for (const q of exportObj.problems) {
      lines.push(`## 第${q.no}题`);
      lines.push(`- 类型: \`${q.type}\``);
      if (q.problemId != null) lines.push(`- 题目ID: \`${q.problemId}\``);
      if (q.score != null) lines.push(`- 分值: \`${q.score}\``);

      if (q.type === "MultipleChoice") {
        // 题干（第一个资源URL，排除选项后）
        if (q.stemAsset) {
          lines.push("");
          lines.push(`**题干**`);
          lines.push("");
          lines.push(formatImageUrl(q.stemAsset, "题干图片", "题干"));
        }

        // 选项（按A/B/C/D顺序）
        const choiceKeys = ["A", "B", "C", "D", "E", "F"];
        const hasChoices = choiceKeys.some(k => q.choiceAssets?.[k]);
        if (hasChoices) {
          lines.push("");
          lines.push(`**选项**`);
          for (const k of choiceKeys) {
            if (q.choiceAssets?.[k]) {
              const url = q.choiceAssets[k];
              lines.push("");
              lines.push(`**${k}.**`);
              lines.push(formatImageUrl(url, k, `选项${k}`));
            }
          }
        }

        // 作答
        lines.push("");
        lines.push(`**作答**`);
        lines.push(`- 正确答案: \`${q.correctAnswer ?? ""}\``);
        lines.push(`- 你的答案: \`${q.userAnswer ?? ""}\``);
        lines.push(`- 是否正确: \`${q.isCorrect ?? ""}\``);

        // 解析（如果有）
        if (q.explanationText) {
          lines.push("");
          lines.push(`**解析**`);
          lines.push("");
          lines.push(q.explanationText);
        }
      } else {
        // 非选择题：保持原有逻辑，但也要修改图片格式
        if (q.assets && q.assets.length) {
          lines.push("");
          lines.push(`**资源**`);
          for (const u of q.assets) {
            lines.push(formatImageUrl(u, "资源图片", "资源"));
          }
        }
      }

      if (q.type === "FillBlank") {
        lines.push("");
        lines.push(`**作答**`);
        lines.push(`- 顺序不敏感: \`${q.orderInsensitive}\``);
        lines.push(`- 是否正确: \`${q.isCorrect}\``);
        if (q.resultScore != null) lines.push(`- 得分: \`${q.resultScore}\``);

        lines.push("");
        lines.push(`**空列表**`);
        for (const b of (q.blanks || [])) {
          const user = q.userAnswerMap?.[String(b.num)] ?? q.userAnswerMap?.[b.num] ?? "";
          const ok = (q.correctBlanks || []).includes(b.num);
          lines.push(`- 空${b.num}:`);
          lines.push(`  - 你的答案: \`${user}\``);
          lines.push(`  - 正确: \`${ok}\``);
          lines.push(`  - 允许答案: ${b.answers.map(a => `\`${a}\``).join(" / ")}`);
          lines.push(`  - CaseSensitive: \`${b.caseSensitive}\`, FuzzyMatch: \`${b.fuzzyMatch}\``);
        }

        if (q.correctAnswerSummary) {
          lines.push("");
          lines.push(`**题库汇总答案串（原样）**`);
          lines.push("");
          lines.push(`\`${q.correctAnswerSummary}\``);
        }
      }

      lines.push("");
      lines.push("---");
      lines.push("");
    }

    return lines.join("\n");
  }

  /** =========================
   *  5) UI：浮动卡片
   *  ========================= */
  function makeBtn(text, onClick) {
    const b = document.createElement("button");
    b.textContent = text;
    b.style.cssText =
      'display:block;width:100%;margin:8px 0;padding:10px 16px;border:0;' +
      'border-radius:8px;cursor:pointer;background:linear-gradient(135deg, #1677ff 0%, #4096ff 100%);color:#fff;font-size:14px;' +
      'font-weight:500;transition:all 0.2s;box-shadow:0 2px 8px rgba(22,119,255,0.3);';
    b.addEventListener('mouseenter', () => {
      b.style.background = 'linear-gradient(135deg, #4096ff 0%, #69b7ff 100%)';
      b.style.boxShadow = '0 4px 16px rgba(22,119,255,0.4)';
      b.style.transform = 'translateY(-1px)';
    });
    b.addEventListener('mouseleave', () => {
      b.style.background = 'linear-gradient(135deg, #1677ff 0%, #4096ff 100%)';
      b.style.boxShadow = '0 2px 8px rgba(22,119,255,0.3)';
      b.style.transform = 'translateY(0)';
    });
    b.addEventListener('click', onClick);
    return b;
  }

  function makePanel() {
    let panel = document.getElementById('__quiz_export_panel__');
    if (panel) return panel;

    panel = document.createElement('div');
    panel.id = '__quiz_export_panel__';
    panel.style.cssText =
      'position:fixed;right:16px;top:50%;transform:translateY(-50%);z-index:999999;' +
      'background:linear-gradient(135deg, #e6f2ff 0%, #e8f4f8 100%);border:1.5px solid #91caff;box-shadow:0 8px 32px rgba(22,119,255,0.2), inset 0 1px 0 rgba(255,255,255,0.6);' +
      'border-radius:16px;padding:20px;width:200px;font-size:13px;backdrop-filter:blur(10px);';
    panel.innerHTML = `
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;">
        <span style="display:inline-block;width:4px;height:16px;background:linear-gradient(180deg, #1677ff 0%, #69b7ff 100%);border-radius:2px;box-shadow:0 0 8px rgba(22,119,255,0.5);"></span>
        <div style="font-weight:700;font-size:16px;color:#0958d9;text-shadow:0 1px 2px rgba(255,255,255,0.8);">布吉岛的小工具</div>
      </div>
      <div style="color:#4a90e2;font-size:12px;margin-bottom:16px;line-height:1.5;">导出当前试卷内容</div>
      <div id="__quiz_export_actions__"></div>
      <div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(145,202,255,0.5);color:#6ba3d8;font-size:11px;text-align:center;">适用小窗试卷</div>
    `;
    document.body.appendChild(panel);
    return panel;
  }

  function toast(msg, ms = 2500) {
    let el = document.getElementById('__quiz_export_toast__');
    if (!el) {
      el = document.createElement('div');
      el.id = '__quiz_export_toast__';
      el.style.cssText =
        'position:fixed;right:16px;bottom:16px;z-index:999999;' +
        'background:rgba(0,0,0,.8);color:#fff;padding:10px 12px;' +
        'border-radius:10px;max-width:360px;font-size:13px;line-height:1.4;';
      document.body.appendChild(el);
    }
    el.textContent = msg;
    el.style.display = 'block';
    setTimeout(() => (el.style.display = 'none'), ms);
  }

  function addButton() {
    const panel = makePanel();
    const actions = document.getElementById('__quiz_export_actions__');
    actions.innerHTML = '';

    const btnJson = makeBtn('一键导出JSON', () => runExport('json'));
    const btnMd = makeBtn('一键导出MD', () => runExport('md'));

    actions.appendChild(btnJson);
    actions.appendChild(btnMd);
  }

  async function runExport(format) {
    const quizId = detectQuizId();
    if (!quizId) {
      toast('未能从当前页面URL推断 quizId。\n请确保你在学生试卷页或 quiz_info 页打开。');
      return;
    }

    const actions = document.getElementById('__quiz_export_actions__');
    const buttons = actions.querySelectorAll('button');
    buttons.forEach(btn => {
      btn.disabled = true;
      btn.textContent = '处理中...';
    });

    try {
      const html = await fetchQuizInfoHtml(quizId);
      const parsed = parseQuizInfoHtml(html);
      const exportObj = buildExport(parsed);

      const baseName = `yuketang_quiz_${exportObj.meta.quizId || quizId}_${nowString()}`;

      if (format === "json") {
        downloadText(`${baseName}.json`, JSON.stringify(exportObj, null, 2), "application/json;charset=utf-8");
        toast('JSON 导出完成');
      } else if (format === "md") {
        const md = toMarkdown(exportObj);
        downloadText(`${baseName}.md`, md, "text/markdown;charset=utf-8");
        toast('Markdown 导出完成');
      }
    } catch (e) {
      console.error(e);
      toast(`导出失败：${e?.message || e}`);
    } finally {
      const actions = document.getElementById('__quiz_export_actions__');
      const buttons = actions.querySelectorAll('button');
      buttons.forEach((btn, idx) => {
        btn.disabled = false;
        btn.textContent = idx === 0 ? '一键导出JSON' : '一键导出MD';
      });
    }
  }

  // 页面加载后插入按钮
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", addButton);
  } else {
    addButton();
  }
})();
