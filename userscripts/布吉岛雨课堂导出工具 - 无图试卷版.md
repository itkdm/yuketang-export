// ==UserScript==
// @name         布吉岛雨课堂导出工具 - 无图试卷版
// @namespace    https://github.com/itkdm
// @version      0.3.0
// @description  布吉岛的小工具 - 导出雨课堂无图试卷（正常试卷）
// @match        https://examination.xuetangx.com/*
// @match        https://www.yuketang.cn/*
// @grant        GM_xmlhttpRequest
// @grant        GM_setValue
// @grant        GM_getValue
// @connect      examination.xuetangx.com
// @connect      www.yuketang.cn
// ==/UserScript==

(function () {
  'use strict';

  const HOST_EXAM = 'https://examination.xuetangx.com';
  const HOST_YKT  = 'https://www.yuketang.cn';

  // ----------------------------
  // Small UI helpers
  // ----------------------------
  function toast(msg, ms = 2500) {
    let el = document.getElementById('__exam_export_toast__');
    if (!el) {
      el = document.createElement('div');
      el.id = '__exam_export_toast__';
      el.style.cssText =
        'position:fixed;right:16px;bottom:16px;z-index:999999;' +
        'background:rgba(0,0,0,.8);color:#fff;padding:10px 12px;' +
        'border-radius:10px;max-width:360px;font-size:13px;line-height:1.4;';
      document.body.appendChild(el);
    }
    el.textContent = msg;
    el.style.display = 'block';
    setTimeout(() => (el.style.display = 'none'), ms);
  }

  function makeBtn(text, onClick) {
    const b = document.createElement('button');
    b.textContent = text;
    b.style.cssText =
      'display:block;width:100%;margin:8px 0;padding:10px 16px;border:0;' +
      'border-radius:8px;cursor:pointer;background:#52c41a;color:#fff;font-size:14px;' +
      'font-weight:500;transition:all 0.2s;box-shadow:0 2px 6px rgba(82,196,26,0.25);';
    b.addEventListener('mouseenter', () => {
      b.style.background = '#73d13d';
      b.style.boxShadow = '0 4px 12px rgba(82,196,26,0.35)';
      b.style.transform = 'translateY(-1px)';
    });
    b.addEventListener('mouseleave', () => {
      b.style.background = '#52c41a';
      b.style.boxShadow = '0 2px 6px rgba(82,196,26,0.25)';
      b.style.transform = 'translateY(0)';
    });
    b.addEventListener('click', onClick);
    return b;
  }

  function makePanel() {
    let panel = document.getElementById('__exam_export_panel__');
    if (panel) return panel;

    panel = document.createElement('div');
    panel.id = '__exam_export_panel__';
    panel.style.cssText =
      'position:fixed;right:16px;top:50%;transform:translateY(-50%);z-index:999999;' +
      'background:#eff4ee;border:1.5px solid #b8d4c0;box-shadow:0 8px 32px rgba(82,196,26,0.15);' +
      'border-radius:16px;padding:20px;width:200px;font-size:13px;';
    panel.innerHTML = `
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;">
        <span style="display:inline-block;width:4px;height:16px;background:#1677ff;border-radius:2px;"></span>
        <div style="font-weight:700;font-size:16px;color:#2d5a3d;">布吉岛的小工具</div>
      </div>
      <div style="color:#5a7a66;font-size:12px;margin-bottom:16px;line-height:1.5;">导出当前测验内容</div>
      <div id="__exam_export_actions__"></div>
      <div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(184,212,192,0.5);color:#8a9a8f;font-size:11px;text-align:center;">适用无图试卷</div>
    `;
    document.body.appendChild(panel);
    return panel;
  }

  function setStatus(s) {
    const el = document.getElementById('__exam_export_status__');
    if (el) el.textContent = s;
  }

  // ----------------------------
  // Network helpers
  // ----------------------------
  function isCrossOrigin(url) {
    try { return new URL(url).origin !== location.origin; } catch { return false; }
  }

  function gmGetJson(url) {
    return new Promise((resolve, reject) => {
      GM_xmlhttpRequest({
        method: 'GET',
        url,
        headers: { 'Accept': 'application/json' },
        responseType: 'text',
        withCredentials: true,
        onload: (r) => {
          try { resolve(JSON.parse(r.responseText)); }
          catch (e) { reject(new Error('JSON parse failed: ' + e.message)); }
        },
        onerror: () => reject(new Error('GM request error')),
        ontimeout: () => reject(new Error('GM request timeout')),
      });
    });
  }

  async function fetchJson(url) {
    // Same-origin: use fetch. Cross-origin: use GM_xmlhttpRequest (Tampermonkey).
    if (!isCrossOrigin(url)) {
      const r = await fetch(url, { credentials: 'include' });
      if (!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}`);
      return await r.json();
    }
    return await gmGetJson(url);
  }

  // ----------------------------
  // Parsing helpers
  // ----------------------------
  function htmlToText(html) {
    if (!html) return '';
    const doc = new DOMParser().parseFromString(html, 'text/html');
    return (doc.body.textContent || '')
      .replace(/\u00A0/g, ' ')
      .replace(/[ \t]+\n/g, '\n')
      .replace(/\n{3,}/g, '\n\n')
      .trim();
  }

  function downloadText(filename, text, mime = 'text/plain;charset=utf-8') {
    const blob = new Blob([text], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1500);
  }

  function getExamIdFromUrl() {
    const u = new URL(location.href);
    const qid = u.searchParams.get('exam_id');
    if (qid) return qid;

    // /result/3829704 or /result/3829704?isFrom=2
    const m = u.pathname.match(/\/result\/(\d+)/);
    if (m) return m[1];

    // /exam_room/xxx?exam_id=
    const m2 = u.href.match(/exam_id=(\d+)/);
    if (m2) return m2[1];

    return null;
  }

  function normalizeExam(coverData, paperData, resultsData, examId) {
    const resList = (resultsData?.problem_results || []);
    const resMap = new Map(resList.map(r => [String(r.problem_id), r]));

    const problems = (paperData?.problems || []);
    const questions = problems.map((p, idx) => {
      const pid = String(p.problem_id ?? p.ProblemID ?? p.ProblemId ?? '');
      const pr = resMap.get(pid) || {};
      const options = (p.Options || []).map(o => ({
        key: o.key,
        text: o.value ? htmlToText(o.value) : ''
      }));

      const typeText = p.TypeText || p.Type || '';
      const correctAnswer = Array.isArray(p.Answer) ? p.Answer : [];
      const myAnswer = Array.isArray(pr.result) ? pr.result : [];

      return {
        index: idx + 1,
        problem_id: pid,
        problem_type: p.ProblemType ?? pr.problem_type ?? null,
        type_text: typeText,
        question: htmlToText(p.Body || ''),
        options,
        correct_answer: correctAnswer,
        my_answer: myAnswer,
        is_correct: typeof pr.correct === 'boolean' ? pr.correct : null,
        score: pr.grade ?? p.score ?? p.Score ?? null
      };
    });

    return {
      exam_id: String(examId),
      title: coverData?.title || paperData?.title || '',
      classroom_id: coverData?.classroom_id ?? null,
      university_id: coverData?.university_id ?? null,
      total_score: coverData?.total_score ?? null,
      problem_count: coverData?.problem_count ?? questions.length,
      show_answer: !!coverData?.show_answer,
      cover: coverData || {},
      summary: {
        grade: resultsData?.grade ?? null,
        duration: resultsData?.duration ?? null,
        create_time: resultsData?.create_time ?? null,
        submit_time: resultsData?.submit_time ?? null,
      },
      questions
    };
  }

  function toMarkdown(normalized) {
    const lines = [];
    lines.push(`# ${normalized.title || 'Exam'}（exam_id=${normalized.exam_id}）`);
    lines.push('');
    lines.push(`- 成绩：${normalized.summary.grade ?? 'N/A'} / ${normalized.total_score ?? 'N/A'}`);
    lines.push(`- 题量：${normalized.questions.length}`);
    lines.push(`- 提交时间：${normalized.summary.submit_time ?? 'N/A'}`);
    lines.push('');

    normalized.questions.forEach(q => {
      lines.push(`## ${q.index}. ${q.type_text || ''}`.trim());
      lines.push('');
      lines.push(q.question || '');
      lines.push('');

      if (q.options?.length) {
        q.options.forEach(o => {
          const label = o.key ? `${o.key}. ` : '- ';
          lines.push(`${label}${o.text || ''}`.trim());
        });
        lines.push('');
      }

      if (normalized.show_answer && q.correct_answer?.length) {
        lines.push(`**正确答案：** ${q.correct_answer.join(', ')}`);
      } else {
        lines.push(`**正确答案：** （当前不允许导出/未开放）`);
      }

      if (q.my_answer?.length) {
        const mark = (q.is_correct === true) ? '✅' : (q.is_correct === false ? '❌' : '');
        lines.push(`**我的答案：** ${q.my_answer.join(', ')} ${mark}`.trim());
      } else {
        lines.push(`**我的答案：** （无记录）`);
      }

      lines.push('');
      lines.push('---');
      lines.push('');
    });

    return lines.join('\n');
  }

  // ----------------------------
  // Main: get exam data
  // ----------------------------
  async function getExamData() {
    const examId = getExamIdFromUrl();
    if (!examId) {
      throw new Error('未从当前 URL 识别到 exam_id。请打开成绩/解析页（/result/xxxx 或 ?exam_id=xxxx）');
    }

    const coverUrl = `${HOST_EXAM}/exam_room/cover?exam_id=${examId}`;
    const cover = await fetchJson(coverUrl);
    if (cover?.errcode !== 0) throw new Error('cover err: ' + (cover?.errmsg || 'unknown'));

    // ✅ 安全阈：只有 show_answer=true 才允许导出"正确答案"
    const allowAnswer = !!cover?.data?.show_answer;

    const paperUrl = `${HOST_EXAM}/exam_room/show_paper?exam_id=${examId}`;
    const resultsUrl = `${HOST_EXAM}/exam_room/problem_results?exam_id=${examId}`;

    const paper = await fetchJson(paperUrl);
    if (paper?.errcode !== 0) throw new Error('show_paper err: ' + (paper?.errmsg || 'unknown'));

    const results = await fetchJson(resultsUrl);
    if (results?.errcode !== 0) throw new Error('problem_results err: ' + (results?.errmsg || 'unknown'));

    // 如果不允许看答案，把 Answer 清空（防止"接口返回但页面不开放"的情况）
    if (!allowAnswer && Array.isArray(paper?.data?.problems)) {
      paper.data.problems = paper.data.problems.map(p => ({ ...p, Answer: [] }));
    }

    const normalized = normalizeExam(cover.data, paper.data, results.data, examId);
    return { normalized, examId };
  }

  // ----------------------------
  // Export functions
  // ----------------------------
  async function exportMarkdown() {
    try {
      const { normalized, examId } = await getExamData();
      const safeTitle = (normalized.title || 'exam')
        .replace(/[\\/:*?"<>|]/g, '_')
        .slice(0, 50);
      downloadText(`${safeTitle}_${examId}.md`, toMarkdown(normalized), 'text/markdown;charset=utf-8');
      toast('Markdown 导出完成');
    } catch (e) {
      console.error(e);
      toast('导出失败：' + e.message);
    }
  }

  async function exportJson() {
    try {
      const { normalized, examId } = await getExamData();
      const safeTitle = (normalized.title || 'exam')
        .replace(/[\\/:*?"<>|]/g, '_')
        .slice(0, 50);
      downloadText(`${safeTitle}_${examId}.json`, JSON.stringify(normalized, null, 2), 'application/json;charset=utf-8');
      toast('JSON 导出完成');
    } catch (e) {
      console.error(e);
      toast('导出失败：' + e.message);
    }
  }

  // ----------------------------
  // Optional: list exams in classroom (exam_entity_agents)
  // ----------------------------
  async function getCPrefix() {
    // Try saved first
    const saved = GM_getValue('cPrefix', '');
    if (saved) return saved;

    // Try auto-detect from loaded resources
    const entries = performance.getEntriesByType?.('resource') || [];
    for (const it of entries) {
      const name = String(it.name || '');
      const m = name.match(/https:\/\/examination\.xuetangx\.com\/(c\d+)\//);
      if (m) {
        GM_setValue('cPrefix', m[1]);
        return m[1];
      }
    }

    // Prompt user
    const v = prompt('需要 c 前缀（例如 c27）。\n获取方法：F12→Network→筛选 exam_entity_agents→看 URL 里 /c27/ 这段。\n请输入：', 'c27');
    if (v && /^c\d+$/.test(v.trim())) {
      GM_setValue('cPrefix', v.trim());
      return v.trim();
    }
    return null;
  }

  async function listExamsByCover() {
    // 在考试结果页：用 cover 里的 classroom_id + user_id 列出本班测验
    const examId = getExamIdFromUrl();
    if (!examId) return toast('未识别 exam_id，无法从 cover 推导 classroom_id');

    try {
      setStatus('读取 cover…');
      const cover = await fetchJson(`${HOST_EXAM}/exam_room/cover?exam_id=${examId}`);
      if (cover?.errcode !== 0) throw new Error(cover?.errmsg || 'cover error');

      const classroomId = cover?.data?.classroom_id;
      const userId = cover?.data?.user?.user_id;
      if (!classroomId || !userId) throw new Error('cover 中缺少 classroom_id 或 user_id');

      await listExamsByClassroom(classroomId, userId);
    } catch (e) {
      console.error(e);
      toast('列出测验失败：' + e.message);
    }
  }

  async function listExamsByClassroom(classroomId, userId) {
    const cPrefix = await getCPrefix();
    if (!cPrefix) return toast('缺少 c 前缀，无法请求 exam_entity_agents');

    const url = `${HOST_EXAM}/${cPrefix}/online_courseware/agent/exam_entity_agents/?entity_type=1&entity_id=${classroomId}&category=1&has_role=1&user_id=${userId}`;
    setStatus('拉取本班测验列表…');

    const r = await fetchJson(url);
    if (r?.errcode !== 0) throw new Error(r?.errmsg || 'exam_entity_agents error');

    const acts = r?.data?.activities || [];
    const box = document.getElementById('__exam_export_extra__');
    box.innerHTML = '';

    const title = document.createElement('div');
    title.style.cssText = 'font-weight:700;margin:6px 0;';
    title.textContent = `测验列表（${acts.length}）`;
    box.appendChild(title);

    acts.forEach(a => {
      const examId = a.courseware_id;
      const row = document.createElement('div');
      row.style.cssText = 'border:1px solid rgba(0,0,0,.08);border-radius:12px;padding:8px;margin:8px 0;';
      row.innerHTML = `
        <div style="font-weight:600;">${a.title || ''}</div>
        <div style="color:#666;font-size:12px;margin-top:4px;">
          exam_id=${examId} ｜ score=${a.score ?? '-'} / ${a.total_score ?? '-'} ｜ 题量=${a.problem_count ?? '-'}
        </div>
      `;
      const open = document.createElement('a');
      open.href = `${HOST_EXAM}/result/${examId}?isFrom=2`;
      open.target = '_blank';
      open.textContent = '打开成绩页';
      open.style.cssText = 'display:inline-block;margin-top:6px;margin-right:10px;font-size:12px;';

      const exp = document.createElement('a');
      exp.href = 'javascript:void(0)';
      exp.textContent = '直接导出';
      exp.style.cssText = 'display:inline-block;margin-top:6px;font-size:12px;color:#1677ff;';
      exp.addEventListener('click', async () => {
        // 临时“伪装” exam_id：复用导出流程
        const current = location.href;
        history.pushState({}, '', `${HOST_EXAM}/result/${examId}?isFrom=2`);
        await exportCurrentExam();
        history.pushState({}, '', current);
      });

      row.appendChild(open);
      row.appendChild(exp);
      box.appendChild(row);
    });

    setStatus('已加载测验列表');
    toast('已加载测验列表');
  }

  // ----------------------------
  // Yuketang: list courses (optional extension)
  // ----------------------------
  async function listCourses(identity = 2) {
    try {
      setStatus('拉取课程列表…');
      const url = `${HOST_YKT}/v2/api/web/courses/list?identity=${identity}`;
      const r = await fetchJson(url);
      if (r?.errcode !== 0) throw new Error(r?.errmsg || 'courses/list error');

      const list = r?.data?.list || [];
      const box = document.getElementById('__exam_export_extra__');
      box.innerHTML = '';

      const title = document.createElement('div');
      title.style.cssText = 'font-weight:700;margin:6px 0;';
      title.textContent = `课程列表（${list.length}）`;
      box.appendChild(title);

      list.forEach(item => {
        const row = document.createElement('div');
        row.style.cssText = 'border:1px solid rgba(0,0,0,.08);border-radius:12px;padding:8px;margin:8px 0;';
        row.innerHTML = `
          <div style="font-weight:600;">${item.course?.name || ''}｜${item.name || ''}</div>
          <div style="color:#666;font-size:12px;margin-top:4px;">
            classroom_id=${item.classroom_id} ｜ teacher=${item.teacher?.name || '-'}
          </div>
        `;

        const hint = document.createElement('div');
        hint.style.cssText = 'margin-top:6px;color:#888;font-size:12px;';
        hint.textContent = '要从“课程→测验列表”需要 user_id 与 c 前缀；建议在任意成绩页点“列出本班测验”更省事。';
        row.appendChild(hint);

        box.appendChild(row);
      });

      setStatus('已加载课程列表');
      toast('已加载课程列表');
    } catch (e) {
      console.error(e);
      toast('课程列表失败：' + e.message);
    }
  }

  // ----------------------------
  // Boot
  // ----------------------------
  function boot() {
    // Only show panel on examination domain
    if (location.hostname !== 'examination.xuetangx.com') {
      return; // Don't show panel on other domains (e.g., www.yuketang.cn)
    }

    const panel = makePanel();
    const actions = document.getElementById('__exam_export_actions__');
    actions.innerHTML = '';

    // Show two export buttons
    actions.appendChild(makeBtn('一键导出MD', exportMarkdown));
    actions.appendChild(makeBtn('一键导出JSON', exportJson));
  }

  // Delay a bit for SPA pages
  setTimeout(boot, 1200);
})();
